────────────────────────────────────────
【專案】AI協作流程規範細節說明（proj1）
【目的】固定流程、避免遺漏；每次新視窗先上傳此檔讓助手讀規範，請AstorChang詳讀並恪守規範。
────────────────────────────────────────
版本：proj1\_作業規範\_v2025-10-16
作者：KeChih × AI 協作（固定更新於專案主線）
────────────────────────────────────────

## 一、執行環境（固定）
1\) 一律使用 PowerShell 7（工作列釘選的 pwsh）。
2\) 【原則】執行上下文 (Execution Context)：
&nbsp;  【強制】所有 SOP 流程與 `run_all_daily.ps1` 腳本，必須假定其
&nbsp;  「當前工作目錄」 (CWD) 已位於專案根目錄 (`proj1\`)。
3\) 【原則】環境抽象化：
&nbsp;  【禁止】本規範 (SOP) 及所有腳本不得硬編碼絕對路徑。
&nbsp;  此行為嚴重違反《寫檔規範》。
&nbsp;  【強制】`run_all_daily.ps1` 必須使用「相對路徑」設置
&nbsp;  環境變數，例如：`$Env:LOG_TASK_CSV = ".\\out\\task_log.csv"`。

## 二、SOP（手動／排程均適用）
1\) 主流程（每日）
&nbsp;  【注意】請先手動 `cd` 至專案根目錄 (`proj1\`)。
&nbsp;  `.\run_all_daily.ps1`
2\) 快檢（10 分鐘內產物 + 警示 + 日誌）
&nbsp;  `Get-ChildItem .\\out |`
`? LastWriteTime -gt (Get-Date).AddMinutes(-10) |`
&nbsp;    `Select Name,Length,LastWriteTime`
&nbsp;  `Get-Content .\\out\\alerts\_auto\_$(Get-Date -Format yyyyMMdd).txt`
&nbsp;  `Get-Content .\\out\\task\_log.csv -Last 3`

## 三、警示規則（雞蛋）
1\) 門檻（嚴格「超過」）：
&nbsp;  >10%＝示警、>20%＝異常、>50%＝嚴重（>50% 需「停止後續流程」）
2\) 預設資料來源（2025-10-10 版）：
&nbsp;  - 優先讀取 `.\\out\\eggs\_metrics\_\*`（先 `\*\_u8.csv`）
&nbsp;  - 價格欄先鎖 `egg\_origin\_price`（待 `washed\_bulk12kg` 有值再切換）
3\) 演算法（`eggs\_alerts\_auto.py` v0.4）：
&nbsp;  - 取來源檔內的「最早 vs 最晚」兩點來計算漲幅
&nbsp;  - 可改用 `--baseline-date` / 
`--current-date` 指定日期
4\) >50% 時行為：
&nbsp;  - 立 `out\\alerts\_stop.flag`、logger 記錄為「嚴重」、流程終止

## 四、錯誤上報「最少回傳」契約（提高效率）
1\) 任務失敗 → 只貼回：
&nbsp;  `$Error\[0].Exception.Message`
2\) Python 任務 → 追加：
&nbsp;  `$LASTEXITCODE`
&nbsp;  （必要時）部分 stdout：`$result |`
`Select -First 80`
3\) 不要在同一輪貼過多無關訊息；一個錯誤解完再下一步。

## 五、互動與步驟節奏
1\) 一次僅給「最多三個原子步驟」；失敗就停、修完再進下一步。
2\) 我若貼 LOG，你只挑核心問題解；避免岔題（例如 Nerd Font 警告）。
3\) 你提供的檔案更新，務必「完整檔案內容」，不是片段補丁。
4\) 任何指令前加 `cd` 到專案根；若要用 CMD 必須特別聲明（預設不用 CMD）。
5\) 如提供下載之檔案，務必提供放置檔案之資料夾完整路徑。

## 六、SSL／憑證
1\) `eggs` / `onion` / `moa` 全部走 `REQUESTS\_CA\_BUNDLE` 指定的 `cacert\_plus\_moa.pem`
2\) 若有 `common\\ssl\\prepare\_moa\_ca\_common.ps1` 就先執行，沒有則跳過。

## 七、版本對照（2025-10-10 現況）
1\) - `run\_all\_daily.ps1`：v3.3.1（只餵 metrics 給警示；無 45 分鐘等待）
2\) - `Update-ProjectFile.ps1`：v2.2（`-Backup` / `-BackupTimestamp` switch）
3\) - `eggs\_alerts\_auto.py`：v0.4（優先序選檔＋欄位偵測穩健）
4\) - `log\_task\_cli.py`：v2.1（支援 `LOG\_TASK\_CSV`；robust upsert）
5\) - `eggs\_alerts.py`：v0.1（41→48 範例用；現階段僅示教）

## 八、常見坑位（禁止）
1\) - 在 `C:\\Windows` 下執行，導致輸出被寫進 `C:\\Windows\\out`
2\) - 不加值的 `-Backup`（舊語法）→ 需改用 `-Backup` 或 `-BackupTimestamp`（switch）
3\) - 撿到 `eggs\_daily\_\*.csv` 充當資料源（它是執行日誌），警示應讀 `metrics`
4\) - 在 CMD 下用 `^` 斷行（預設一律 pwsh）

## 九、收尾快檢清單（操作者照抄即可）
1\) - 有 `ALL DONE`
2\) - `.\\out\\alerts\_auto\_YYYYMMDD.txt` 存在、可讀
3\) - `task\_log.csv` 追加當日 `eggs\_alerts\_auto` 記錄
4\) - 若有 `alerts\_stop.flag` → 流程應已中止（屬>50%）

## 十、長期作業方針（跨專案適用）
1\) 國際情勢監控：
&nbsp;  - Fonterra GDT（無鹽奶油、全脂奶粉）須持續追蹤。
&nbsp;  - 每月第 1、3 週二開標。開標前兩日提供 FAS 預測值（紐西蘭港口價）。
&nbsp;  - 官方公布成交後，依當時船運費率估算 CIF 基隆港價格。
&nbsp;  - 單位：美元／公噸。
2\) 農業部 OpenData 擷取：
&nbsp;  - 農產品主體已完成基本架構，後續將建置：
&nbsp;    果菜、花卉、漁產、毛豬、家禽(白肉雞/雞蛋)、
&nbsp;    產銷履歷、農情預測、臺灣地區農產品生產量值、
&nbsp;    產地價格資料、果菜及花卉市場休市日…等數十筆 API。
&nbsp;  - 所有 API 規格文件（OpenData+API 介接說明書）均已下載留存。
3\) 語言規範：
&nbsp;  - 無論使用者以何種語言提問或對話，除非明確要求翻譯，
&nbsp;    否則回應一律以繁體中文撰寫。
&nbsp;  - 若要求翻譯，僅翻譯指定內容，其他互動仍維持繁體中文。
4\) 對話主題管理：
&nbsp;  - 若討論中出現「離題但重要」的新主題，AI 必須主動提醒
&nbsp;    並詢問是否要開「新對話視窗或新專案」。
5\) 持續監控原物料行情與國際新聞，
&nbsp;  包括能源、乳品、穀物、航運、氣候與匯率動態。

## 十一、逾期備援生成規範
1\) 若發生「程式碼執行器工作階段已逾期」導致無法下載檔案，AI 應將程式碼腳本
&nbsp;  貼到對話窗提供使用者執行或於本機（KCH-WS01）一鍵生成相同內容之檔案。
2\) 檔案應包含所有結構（分頁、條件格式、驗證、公式、角色視圖、替代群組邏輯等），
&nbsp;  並以完整檔案方式產生。
3\) 請一律以python寫檔。

## 十二、提供檔案之相關規範
1\) - AI負責提供「一貼就能跑、會自動建立檔案」的版本程式碼，並說明執行過程。
2\) - AI預設提供可直接貼上執行的腳本建立器（含完整路徑、示範執行），並說明
&nbsp;  執行方式與細節，避免使用者「不知所措」。
3\) - 所有於Powershell執行程式碼後，"不可"自動關閉PS視窗，以便呈現Logs，
&nbsp;  提升效率。

────────────────────────────────────────
版本：proj1\_作業規範\_v2025-10-16
作者：KeChih × AstorChang-AI 協作
────────────────────────────────────────

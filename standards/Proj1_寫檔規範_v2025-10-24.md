# 《proj1 寫檔規範 v2025-10-23 (Final)》
> [cite_start]本規範為 Project Lumen / proj1 之「專案律法」。所有程式與自動化流程必須遵守，並通過 auditor 的稽核。 [cite: 168]

## 1. 總則
- [cite_start]**目的**：確保所有寫入檔案之動作具備安全性、可移植性、可追蹤性。 [cite: 170]
- [cite_start]**範圍**：適用於 proj1 底下所有 Python、PowerShell、VBA 與相關自動化模組。 [cite: 171]
- [cite_start]**核心原則**：**PowerShell 發號施令，Python 寫檔**。 [cite: 172]
  - [cite_start]PowerShell：負責流程、參數、排程、喚起 Python；不得直接寫永久檔。 [cite: 173]
  - [cite_start]Python：負責實體檔案的生成、寫入、轉換與驗證。 [cite: 174]
- [cite_start]**稽核要求**：所有提交須通過 `auditor.py` 稽核。 [cite: 175]
  - [cite_start]**Error**：禁止提交，務必修正。 [cite: 176]
  - [cite_start]**Warn**：可提交，但需在變更紀錄註明原因。 [cite: 177]

## 2. 編碼與換行（Encoding & EOL）
- [cite_start]**統一編碼**：
- [cite_start]  **a. 資料交換檔 (.csv, .txt)**：【強制】**UTF-8 with BOM** (Python 應使用 `utf-8-sig`)。
- [cite_start]  **b. 程式碼/設定檔 (.py, .ps1, .json)**：【強制】**UTF-8** (無 BOM)。
- [cite_start]**換行符**：一律 **CRLF (\r\n)**。 [cite: 180]
- [cite_start]**Python 寫入**： [cite: 181]
  - [cite_start]`write_text(..., encoding='utf-8-sig', newline='\r\n')` [cite: 182]
  - [cite_start]`open(..., encoding='utf-8-sig', newline='\r\n')` [cite: 183]
  - [cite_start]`pandas.DataFrame.to_csv(..., line_terminator='\r\n', encoding='utf-8-sig')` [cite: 184]
- [cite_start]**PowerShell 暫存寫入**（僅限 out\tmp\）：`Set-Content -Encoding utf8` / `Out-File -Encoding utf8` [cite: 185]
- [cite_start]**稽核對應**：`ENC-UTF8-001`（非 UTF-8）、`EOL-CRLF-001`（換行不合規）。 [cite: 186]

## 3. 資料格式規範 (Data Format Specification)
- 3-1. **主要格式**：【強制】所有表格式 (Tabular) 資料交換檔，一律使用 **CSV (Comma-Separated Values)** 格式。
- 3-2. **格式一致性**：【禁止】使用 TSV (Tab-Separated Values) 或其他自訂分隔符，以維持架構單一性。
- 3-3. **標頭 (Header)**：【強制】所有 CSV 檔案的第一行**必須**包含標頭 (Header)。
- 3-4. **分隔符**：【強制】使用**逗號 (comma)** 作為分隔符。
- 3-5. **稽核對應**：`FMT-CSV-001` (未使用標準 CSV 格式), `FMT-HEADER-001` (缺少標頭)。

## 4. 目錄與命名
| 類型 | 目錄 | 規範 |
|---|---|---|
| 輸出檔 | `out\` | [cite_start]永久留存，可追蹤；禁止由 PowerShell 直接寫入 | [cite: 191, 192]
| 暫存檔 | `out\tmp\` | [cite_start]僅允許 PowerShell 暫寫；必須就近註解 `//TEMP` | [cite: 193, 194]
| 日誌檔 | `out\logs\` | [cite_start]由 Python 或 PsIO 模組統一產出 | [cite: 195]
| 設定檔 | `config\` | [cite_start]只讀、不得在流程中覆寫 | [cite: 196, 197]
| 程式碼 | `tools\`, `meta_audit\`, `A_line\`, `B_line\` | [cite_start]PascalCase + 動詞開頭（Invoke-/Convert-/Update- ...） | [cite: 198]

> [cite_start]禁止硬編碼絕對路徑（如 `C:\...`）與 `..\` 相對跳脫；以 `ROOT / "out" / "file.ext"` 或 `Join-Path` 組合。 [cite: 199]

## 5. Python 規範
- [cite_start]**I/O 宣告（強制）**：凡執行實體 I/O 之腳本，檔頭需有 `__IO_SPEC__`： [cite: 201]
  ```python
  __IO_SPEC__ = {
      [cite_start]"inputs":  [{"name": "config", "path": "config/config_global.json", "type": "json", "required": true}], [cite: 204]
      [cite_start]"outputs": [{"name": "result", "path": "out/samples/result.json", "type": "json"}], [cite: 205]
      "exitcode": {"0": "success", "1": "error"} [cite: 206]
  }